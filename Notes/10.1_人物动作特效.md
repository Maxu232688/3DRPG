# 人物动作特效

按照原工程里面的设置调整并保存特效预制体

加上影子的projector

按照课程中做完后，要加上相关的控制

在Player下新建脚本PlayerParticles

```csharp
public class PlayerParticles : MonoBehaviour
{
    public float walkDustMinSpeed = 3.5f;
    public float landingParticleMinSpeed = 5f;
    public ParticleSystem walkDust;
    public ParticleSystem landingDust;
    public ParticleSystem hurtDust;
    
    protected Player m_player;

    public virtual void Play(ParticleSystem particle)
    {
        if (!particle.isPlaying)
        {
            particle.Play();
        }
    }

    public virtual void Stop(ParticleSystem particle, bool clear = false)
    {
        if (particle.isPlaying)
        {
            // 停止播放有两种模式，清除和不清除
            var mode = clear
                ? ParticleSystemStopBehavior.StopEmittingAndClear
                : ParticleSystemStopBehavior.StopEmitting;
            particle.Stop(true, mode);
        }
    }
    
    protected virtual void HandleLandParticle()
    {
        // 不在水里且落地速度大于设定的速度
        if (!m_player.onWater && Mathf.Abs(m_player.velocity.y) >= landingParticleMinSpeed)
        {
            Play(landingDust);
        }
    }

    protected virtual void HandleWalkParticle()
    {
        // 在地上且不在水里时
        if (m_player.isGrounded && !m_player.onWater)
        {
            // 走路速度大于设定值
            if (m_player.lateralVelocity.magnitude > walkDustMinSpeed)
            {
                Play(walkDust);
            }
            else
            {
                Stop(walkDust);
            }
        }
        else
        {
            Stop(walkDust);
        }
    }

    protected virtual void HandleHurtParticle()
    {
        Play(hurtDust);
    }
    
    protected void Start()
    {
        m_player = GetComponent<Player>();
        m_player.entityEvents.OnGroundEnter.AddListener(HandleLandParticle);
        // 注意这里别写错了，这里是playerEvents中的受伤事件
        m_player.playerEvents.OnHurt.AddListener(HandleHurtParticle);
    }

    protected virtual void Update()
    {
        HandleWalkParticle();
    }
}
```

把这个脚本挂在Lily预制体上，把刚刚做好的三个特效拖到上面。

那么攻击特效需要用到trailRenderer，在Lily预制体中添加这个节点并加上这个组件，按照原工程进行调整

在Player下新建脚本 PlayerSpinTrail

```csharp
[RequireComponent(typeof(TrailRenderer))]
public class PlayerSpinTrail : MonoBehaviour
{
    // 父节点要在手上
    public Transform hand;
    // 我这里加了一个offset，可以让这个轨道位置偏外侧一些，这样旋风的感觉更好
    // 注意更改的是y的值，你可以在unity里面试着改一下看看效果
    public Vector3 offset;
    
    protected TrailRenderer m_trail;
    protected Player m_player;
    
    
    protected virtual void InitializeTrail()
    {
        m_trail = GetComponent<TrailRenderer>();
        m_trail.enabled = false;
    }

    protected virtual void InitializeTransform()
    {
        transform.parent = hand;
        // 在这里加上offset
        transform.localPosition = Vector3.zero + offset;
    }

    protected virtual void InitializePlayer()
    {
        // 要注意这个脚本是要挂到Trail上的，不是Player上的，所以要在父对象里面找Player
        m_player = GetComponentInParent<Player>();
        m_player.states.events.onChange.AddListener(HandleActive);
    }

    protected virtual void HandleActive()
    {
        if (m_player.states.IsCurrentOfType(typeof(SpinPlayerState)))
        {
            m_trail.enabled = true;
        }
        else
        {
            m_trail.enabled = false;
        }
    }
    
    protected void Start()
    {
        InitializeTrail();
        InitializeTransform();
        InitializePlayer();
    }
}
```

挂上脚本，把手拖给它，也可能做两只手的，但是我觉得做了两只手的没那么好看，太厚了。

运行就能显示特效了